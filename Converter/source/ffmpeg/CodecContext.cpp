#include "CodecContext.h"

///////////////////////////////////////////////////////////////////////////////////////////////

ACodecContext::ACodecContext()
{
	Initialize();
}

///////////////////////////////////////////////////////////////////////////////////////////////

ACodecContext::~ACodecContext()
{
	Cleanup();
}

///////////////////////////////////////////////////////////////////////////////////////////////

void ACodecContext::Initialize()
{
	Codec    = NULL;
	CodecCtx = NULL;
}

///////////////////////////////////////////////////////////////////////////////////////////////

void ACodecContext::Cleanup()
{
	FreeContext();
}

///////////////////////////////////////////////////////////////////////////////////////////////

AVCodec* ACodecContext::GetCodec()
{
	return Codec;
}

///////////////////////////////////////////////////////////////////////////////////////////////

AVCodecContext* ACodecContext::GetCtx()
{
	return CodecCtx;
}

///////////////////////////////////////////////////////////////////////////////////////////////

bool ACodecContext::AllocContext()
{
	FreeContext();
	CodecCtx = avcodec_alloc_context3(Codec);
	return CodecCtx != NULL;
}

///////////////////////////////////////////////////////////////////////////////////////////////

bool ACodecContext::GetCodecFromStream(AVStream* stream)
{
	CodecCtx = stream->codec;
	if(!CodecCtx)
		return false;

	Codec = avcodec_find_decoder(CodecCtx->codec_id);
	return Codec != NULL;
}

///////////////////////////////////////////////////////////////////////////////////////////////

bool ACodecContext::OpenCodec()
{
	if(!CodecCtx || !Codec)
		return false;

	int res = avcodec_open2(CodecCtx, Codec, NULL);
	return res >= 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////

bool ACodecContext::FindDecoder(AVCodecID id)
{
	if(!CodecCtx)
		return false;

	Codec = avcodec_find_decoder(id);
	return Codec != NULL;
}

///////////////////////////////////////////////////////////////////////////////////////////////

bool ACodecContext::FindEncoder(AVCodecID id)
{
	if(!CodecCtx)
		return false;

	Codec = avcodec_find_encoder(id);
	return Codec != NULL;
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

int ACodecContext::GetWidth()
{
	return CodecCtx->width;
}

///////////////////////////////////////////////////////////////////////////////////////////////

int ACodecContext::GetHeight()
{
	return CodecCtx->height;
}

///////////////////////////////////////////////////////////////////////////////////////////////

void ACodecContext::GetSize(int &w, int &h)
{
	w = CodecCtx->width;
	h = CodecCtx->height;
}

///////////////////////////////////////////////////////////////////////////////////////////////

void ACodecContext::SetSize(int w, int h)
{
	CodecCtx->width  = w;
	CodecCtx->height = h;
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void CVideoDecoder::Setup()
{

}

///////////////////////////////////////////////////////////////////////////////////////////////

void CVideoDecoder::FreeContext()
{
	if(CodecCtx)
		avcodec_close(CodecCtx);

	Initialize();
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void CVideoEncoder::Setup(int width, int height, int bitrate, AVRational framerate, int gop_size, int max_b_frames, AVPixelFormat pix_fmt)
{
	CodecCtx->width  = width;
	CodecCtx->height = height;

	CodecCtx->bit_rate  = bitrate;
	CodecCtx->time_base = framerate;

	CodecCtx->pix_fmt      = pix_fmt;
	CodecCtx->gop_size     = gop_size;
	CodecCtx->max_b_frames = max_b_frames;
}

///////////////////////////////////////////////////////////////////////////////////////////////

void CVideoEncoder::FreeContext()
{
	if(CodecCtx){
		avcodec_close(CodecCtx);
		av_free(&CodecCtx);
	}

	Initialize();
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void CAudioDecoder::FreeContext()
{
	if(CodecCtx)
		avcodec_close(CodecCtx);

	Initialize();
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void CAudioEncoder::FreeContext()
{
	if(CodecCtx){
		avcodec_close(CodecCtx);
		av_free(&CodecCtx);
	}

	Initialize();
}
